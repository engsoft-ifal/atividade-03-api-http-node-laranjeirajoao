name: Autograding

on: [push]

jobs:
   test-api:
      runs-on: ubuntu-latest

      steps:
         - uses: actions/checkout@v4

         - name: Check minimum commits
           run: |
              COUNT=$(git rev-list --count HEAD)
              if [ "$COUNT" -lt 5 ]; then
                echo "Mínimo de 5 commits não atendido: Atualmente $COUNT"
                exit 1
              fi

         - name: Check server file exists
           run: |
              test -f src/server.js || (echo "src/server.js não encontrado" && exit 1)

         - name: Check Express not used
           run: |
              if grep -Ri "express" .; then
                echo "Express não é permitido"
                exit 1
              fi

         - name: Check ESM usage
           run: |
              if grep -R "require(" src; then
                echo "require() não permitido. Use import/export"
                exit 1
              fi
              grep -R "import " src || (echo "import não encontrado" && exit 1)

         - name: Setup Node
           uses: actions/setup-node@v4
           with:
              node-version: 20

         - name: Install dependencies
           run: npm install

         - name: Start server
           run: |
              node src/server.js &
              sleep 5

         - name: Extract matricula
           id: matricula
           run: |
              MATRICULA=$(grep -i "Matrícula:" README.md | awk '{print $2}')
              LAST_DIGIT=${MATRICULA: -1}
              VARIACAO=$((LAST_DIGIT % 4))
              echo "variacao=$VARIACAO" >> $GITHUB_OUTPUT

         - name: Define resource
           id: resource
           run: |
              if [ "${{ steps.matricula.outputs.variacao }}" = "0" ]; then
                echo "resource=atendimentos" >> $GITHUB_OUTPUT
              elif [ "${{ steps.matricula.outputs.variacao }}" = "1" ]; then
                echo "resource=chamados" >> $GITHUB_OUTPUT
              elif [ "${{ steps.matricula.outputs.variacao }}" = "2" ]; then
                echo "resource=protocolos" >> $GITHUB_OUTPUT
              else
                echo "resource=requerimentos" >> $GITHUB_OUTPUT
              fi

         - name: Install jq
           run: sudo apt-get update && sudo apt-get install -y jq

         # -----------------------
         # TESTE HEALTH
         # -----------------------

         - name: Test health status 200
           run: |
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health)
              [ "$STATUS" = "200" ] || exit 1

         - name: Test health returns JSON
           run: |
              curl -s http://localhost:3000/health | jq . > /dev/null

         # -----------------------
         # TESTE GET LISTA INICIAL
         # -----------------------

         - name: Test GET list returns array
           run: |
              curl -s http://localhost:3000/${{ steps.resource.outputs.resource }} | jq 'type' | grep array

         # -----------------------
         # TESTE POST VÁLIDO
         # -----------------------

         - name: Create first item
           id: create1
           run: |
              RESOURCE=${{ steps.resource.outputs.resource }}

              if [ "$RESOURCE" = "atendimentos" ]; then
                DATA='{"aluno":"Joao","assunto":"Duvida"}'
              elif [ "$RESOURCE" = "chamados" ]; then
                DATA='{"solicitante":"Maria","descricao":"Problema","prioridade":"alta"}'
              elif [ "$RESOURCE" = "protocolos" ]; then
                DATA='{"nome":"Carlos","tipo":"Interno","data":"2025-01-01"}'
              else
                DATA='{"estudante":"Ana","categoria":"Financeiro","observacao":"Urgente"}'
              fi

              RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/$RESOURCE \
                -H "Content-Type: application/json" \
                -d "$DATA")

              BODY=$(echo "$RESPONSE" | head -n1)
              STATUS=$(echo "$RESPONSE" | tail -n1)

              [ "$STATUS" = "201" ] || exit 1

              ID=$(echo "$BODY" | jq '.id')
              echo "id1=$ID" >> $GITHUB_OUTPUT

         - name: Create second item (check incremental ID)
           run: |
              RESOURCE=${{ steps.resource.outputs.resource }}

              if [ "$RESOURCE" = "atendimentos" ]; then
                DATA='{"aluno":"Pedro","assunto":"Nota"}'
              elif [ "$RESOURCE" = "chamados" ]; then
                DATA='{"solicitante":"Luiz","descricao":"Erro","prioridade":"media"}'
              elif [ "$RESOURCE" = "protocolos" ]; then
                DATA='{"nome":"Julia","tipo":"Externo","data":"2025-02-01"}'
              else
                DATA='{"estudante":"Bruno","categoria":"Academico","observacao":"Normal"}'
              fi

              RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/$RESOURCE \
                -H "Content-Type: application/json" \
                -d "$DATA")

              BODY=$(echo "$RESPONSE" | head -n1)
              STATUS=$(echo "$RESPONSE" | tail -n1)

              [ "$STATUS" = "201" ] || exit 1

              ID2=$(echo "$BODY" | jq '.id')
              ID1=${{ steps.create1.outputs.id1 }}

              [ "$ID2" -gt "$ID1" ] || exit 1

         # -----------------------
         # TESTE GET POR ID
         # -----------------------

         - name: Test GET by valid ID
           run: |
              RESOURCE=${{ steps.resource.outputs.resource }}
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/$RESOURCE/1)
              [ "$STATUS" = "200" ] || exit 1

         - name: Test GET invalid ID returns 404
           run: |
              RESOURCE=${{ steps.resource.outputs.resource }}
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/$RESOURCE/9999)
              [ "$STATUS" = "404" ] || exit 1

         # -----------------------
         # TESTES DE ERRO
         # -----------------------

         - name: Test invalid JSON returns 400
           run: |
              RESOURCE=${{ steps.resource.outputs.resource }}
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
                -X POST http://localhost:3000/$RESOURCE \
                -H "Content-Type: application/json" \
                -d '{ invalido')
              [ "$STATUS" = "400" ] || exit 1

         - name: Test missing field returns 422
           run: |
              RESOURCE=${{ steps.resource.outputs.resource }}
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
                -X POST http://localhost:3000/$RESOURCE \
                -H "Content-Type: application/json" \
                -d '{}')
              [ "$STATUS" = "422" ] || exit 1
